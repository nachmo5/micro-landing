---
import { useTypography } from "../lib/typography";

const lang = Astro.locals.lang;
const t = useTypography(lang);
---

<div
  id="cookie-consent"
  class="cookie-banner"
  role="dialog"
  aria-label="Cookie consent"
  hidden
>
  <div class="cookie-inner">
    <p class="cookie-message">{t("consent.message")}</p>
    <div class="cookie-actions">
      <button
        id="cookie-decline"
        class="cookie-btn cookie-btn--ghost"
        type="button"
      >
        {t("consent.decline")}
      </button>
      <button
        id="cookie-accept"
        class="cookie-btn cookie-btn--primary"
        type="button"
      >
        {t("consent.accept")}
      </button>
    </div>
  </div>
</div>

<script>
  (function () {
    const STORAGE_KEY = "cookie-consent";
    const banner = document.getElementById("cookie-consent") as HTMLElement;

    function grantConsent() {
      // Use the global gtag function declared in <head>
      (window as any).gtag("consent", "update", { analytics_storage: "granted" });
    }

    function hideBanner() {
      banner.hidden = true;
    }

    function showBanner() {
      banner.hidden = false;
    }

    function deleteCookies() {
      document.cookie.split(";").forEach((c) => {
        const name = c.split("=")[0].trim();
        if (name.startsWith("_ga") || name === "_gid") {
          const domains = [location.hostname, "." + location.hostname];
          domains.forEach((d) => {
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=${d}`;
          });
          document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
        }
      });
    }

    // Init: check existing consent
    const consent = localStorage.getItem(STORAGE_KEY);
    if (consent === "accepted") {
      // consent already granted in head inline script
    } else if (!consent) {
      showBanner();
    }

    // Accept
    document.getElementById("cookie-accept")!.addEventListener("click", () => {
      localStorage.setItem(STORAGE_KEY, "accepted");
      grantConsent();
      hideBanner();
    });

    // Decline
    document.getElementById("cookie-decline")!.addEventListener("click", () => {
      localStorage.setItem(STORAGE_KEY, "declined");
      hideBanner();
    });

    // Withdraw â€” callable from footer link or privacy page
    (window as any).__withdrawCookieConsent = function () {
      localStorage.removeItem(STORAGE_KEY);
      deleteCookies();
      location.reload();
    };
  })();
</script>

<style>
  .cookie-banner {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 9999;
    background: var(--color-surface);
    border-top: 1px solid var(--color-border);
    box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.08);
  }

  .cookie-inner {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 1.25rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1.5rem;
  }

  .cookie-message {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin: 0;
  }

  .cookie-actions {
    display: flex;
    gap: 0.75rem;
    flex-shrink: 0;
  }

  .cookie-btn {
    font-family: var(--font-sans);
    font-size: 0.8125rem;
    font-weight: 600;
    padding: 0.5rem 1.25rem;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition:
      background var(--transition-fast),
      color var(--transition-fast),
      border-color var(--transition-fast);
    white-space: nowrap;
  }

  .cookie-btn--primary {
    background: var(--color-primary);
    color: #fff;
    border: 1px solid var(--color-primary);
  }

  .cookie-btn--primary:hover {
    background: var(--color-primary-light);
    border-color: var(--color-primary-light);
  }

  .cookie-btn--ghost {
    background: transparent;
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
  }

  .cookie-btn--ghost:hover {
    border-color: var(--color-text-tertiary);
    color: var(--color-text);
  }

  @media (max-width: 640px) {
    .cookie-inner {
      flex-direction: column;
      text-align: center;
      padding: 1.25rem 1.5rem;
    }

    .cookie-actions {
      width: 100%;
    }

    .cookie-btn {
      flex: 1;
    }
  }
</style>
